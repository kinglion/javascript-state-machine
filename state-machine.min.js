define(function(c,b,d){var a={VERSION:"2.3.5",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,PENDING:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(j,k){var m=(typeof j.initial=="string")?{state:j.initial}:j.initial;var i=j.terminal||j["final"];var h=k||j.target||{};var q=j.events||[];var l=j.callbacks||{};var f={};var o={};var p=function(r){var t=(r.from instanceof Array)?r.from:(r.from?[r.from]:[a.WILDCARD]);f[r.name]=f[r.name]||{};for(var s=0;s<t.length;s++){o[t[s]]=o[t[s]]||[];o[t[s]].push(r.name);f[r.name][t[s]]=r.to||t[s]}};if(m){m.event=m.event||"startup";p({name:m.event,from:"none",to:m.state})}for(var g=0;g<q.length;g++){p(q[g])}for(var e in f){if(f.hasOwnProperty(e)){h[e]=a.buildEvent(e,f[e])}}for(var e in l){if(l.hasOwnProperty(e)){h[e]=l[e]}}h.current="none";h.is=function(n){return(n instanceof Array)?(n.indexOf(this.current)>=0):(this.current===n)};h.can=function(n){return !this.transition&&(f[n].hasOwnProperty(this.current)||f[n].hasOwnProperty(a.WILDCARD))};h.cannot=function(n){return !this.can(n)};h.transitions=function(){return o[this.current]};h.isFinished=function(){return this.is(i)};h.error=j.error||function(s,w,v,r,n,u,t){throw t||u};if(m&&!m.defer){h[m.event]()}return h},doCallback:function(j,h,g,l,k,f){if(h){try{return h.apply(j,[g,l,k].concat(f))}catch(i){return j.error(g,l,k,f,a.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",i)}}},beforeAnyEvent:function(g,f,i,h,e){return a.doCallback(g,g.onbeforeevent,f,i,h,e)},afterAnyEvent:function(g,f,i,h,e){return a.doCallback(g,g.onafterevent||g.onevent,f,i,h,e)},leaveAnyState:function(g,f,i,h,e){return a.doCallback(g,g.onleavestate,f,i,h,e)},enterAnyState:function(g,f,i,h,e){return a.doCallback(g,g.onenterstate||g.onstate,f,i,h,e)},changeState:function(g,f,i,h,e){return a.doCallback(g,g.onchangestate,f,i,h,e)},beforeThisEvent:function(g,f,i,h,e){return a.doCallback(g,g["onbefore"+f],f,i,h,e)},afterThisEvent:function(g,f,i,h,e){return a.doCallback(g,g["onafter"+f]||g["on"+f],f,i,h,e)},leaveThisState:function(g,f,i,h,e){return a.doCallback(g,g["onleave"+i],f,i,h,e)},enterThisState:function(g,f,i,h,e){return a.doCallback(g,g["onenter"+h]||g["on"+h],f,i,h,e)},beforeEvent:function(g,f,i,h,e){if((false===a.beforeThisEvent(g,f,i,h,e))||(false===a.beforeAnyEvent(g,f,i,h,e))){return false}},afterEvent:function(g,f,i,h,e){a.afterThisEvent(g,f,i,h,e);a.afterAnyEvent(g,f,i,h,e)},leaveState:function(i,h,k,j,g){var f=a.leaveThisState(i,h,k,j,g),e=a.leaveAnyState(i,h,k,j,g);if((false===f)||(false===e)){return false}else{if((a.ASYNC===f)||(a.ASYNC===e)){return a.ASYNC}}},enterState:function(g,f,i,h,e){a.enterThisState(g,f,i,h,e);a.enterAnyState(g,f,i,h,e)},buildEvent:function(e,f){return function(){var k=this.current;var j=f[k]||f[a.WILDCARD]||k;var h=Array.prototype.slice.call(arguments);if(this.transition){return this.error(e,k,j,h,a.Error.PENDING_TRANSITION,"event "+e+" inappropriate because previous transition did not complete")}if(this.cannot(e)){return this.error(e,k,j,h,a.Error.INVALID_TRANSITION,"event "+e+" inappropriate in current state "+this.current)}if(false===a.beforeEvent(this,e,k,j,h)){return a.Result.CANCELLED}if(k===j){a.afterEvent(this,e,k,j,h);return a.Result.NOTRANSITION}var i=this;this.transition=function(){i.transition=null;i.current=j;a.enterState(i,e,k,j,h);a.changeState(i,e,k,j,h);a.afterEvent(i,e,k,j,h);return a.Result.SUCCEEDED};this.transition.cancel=function(){i.transition=null;a.afterEvent(i,e,k,j,h)};var g=a.leaveState(this,e,k,j,h);if(false===g){this.transition=null;return a.Result.CANCELLED}else{if(a.ASYNC===g){return a.Result.PENDING}else{if(this.transition){return this.transition()}}}}}};d.exports=a});
